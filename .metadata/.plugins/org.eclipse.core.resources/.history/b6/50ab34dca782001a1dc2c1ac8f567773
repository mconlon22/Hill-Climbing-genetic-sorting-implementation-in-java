package LoadStore;

import LoadStore.CandidateFunction.CandidateSolution;

import java.text.DecimalFormat;
import java.util.List;
import java.util.Scanner;

import javax.swing.text.StyledEditorKit.BoldAction;

public class HillClimbing implements HillClimb{
	int systemUpdatesPer=0;
    public CandidateSolution candidate;
    String analysisString="";
    double stalenessFactor=15;
    private static DecimalFormat df2 = new DecimalFormat("#.##");
    int temperature= 1000;
	private List<Project> projects;
    
    
    
    
        HillClimbing(CandidateSolution candidate,List<Project> projects){
        	this.projects=projects;
        this.candidate=candidate;
    }
        
        
        
    public void startHillClimbing(){
        Scanner myObj = new Scanner(System.in);
        System.out.println("Enter number of epochs");
        int numberOfEpochs=Integer.parseInt(myObj.nextLine());
        systemUpdatesPer=numberOfEpochs/20;
    int numImprovements=0;
    Double improvementAmount= (double) 0;
    Double worseningAmount= (double) 0;
    
    int numWorsening=0;
        double changeInEnergy;
        double previousEnergy=0;
        double minFound=candidate.checkEnergy();
        for(int i=0;i<numberOfEpochs;i++){
            CandidateSolution testCandidate=new CandidateSolution();
            testCandidate.setStudentProjectAllocations(candidate.getStudentProjectAllocations());
            testCandidate.randomChange(2,projects);
            
            double testEnergy=testCandidate.checkEnergy();
            double cadidateEnergy=candidate.checkEnergy();
            //System.out.println("testEnergy= "+testEnergy+"      ,   "+"initialEnergy= "+candidate.checkEnergy() );
            double energyDiff=testEnergy-cadidateEnergy;
           // System.out.println(energyDiff );
           temperatureIncrement();

            if(i%systemUpdatesPer==0){
                changeInEnergy=previousEnergy-cadidateEnergy;
                previousEnergy=cadidateEnergy;
                calculateStaleness(changeInEnergy);
                analysisString+="\n"+i +" - "+(i-systemUpdatesPer) +"  Change in energy:  "+df2.format(changeInEnergy)  ;
                System.out.println("# " +i +"  currentEnergy="+cadidateEnergy +"   min Found:"+minFound);
                improvementAmount= (double) 0;
                worseningAmount= (double) 0;
            }
           


            if(Double.compare(testEnergy, cadidateEnergy)==-1){
                candidate.setStudentProjectAllocations(testCandidate.getStudentProjectAllocations());
                numImprovements++;
                improvementAmount+=energyDiff;
                minFound=(cadidateEnergy<minFound)?(cadidateEnergy):(minFound);

            }
            else{
                if(checkAcceptance(energyDiff,temperature)){
                   candidate.setStudentProjectAllocations(testCandidate.getStudentProjectAllocations());
                    numWorsening++ ;
                    worseningAmount+=energyDiff;
                    stalenessFactor=15;

                }
                else{



                }
                
            }
            



        }
        candidate.toEnergyString();
        System.out.println(analysisString );

    }
  
    
    /*
     * returns whether to accept worsening solution
     * */
    public static boolean checkAcceptance(double energyDiff,int temperature){
        double random=Math.random();
        double boltzman=boltzman(energyDiff,temperature);
        return ((random<boltzman)?(true):(false));

    }
      
    /*
     * returns probability of accepting worsening solution
     * */
    
    
    
    public static double boltzman(double energyDiff, int temperature) {
    double e=2.71828;
    double probabilityOfAccepting=1-(1/(Math.pow(e, (energyDiff/temperature))));
    
    return probabilityOfAccepting;
}
    /*
     * temperature is high as the solution is going down to a local minimum to decrease the probability of accepting a worsening solution
     * 
     * */
    
    public void temperatureIncrement(){
{
temperature=  (int) Math.pow(3, stalenessFactor);
}
    }
    
    /*
     * staleness is a number used to calculate the temperature based on how much the solution is changing
     * 
     * */
    
    
    public void calculateStaleness(double energyDiff){
        if(energyDiff==0 && stalenessFactor>=1.5){
        System.out.println("incrementing staleness");
       stalenessFactor-=.5;
        }
        if(energyDiff>0 && stalenessFactor<15){
        
            stalenessFactor+=.5;
             }
    }

}